# 📌 2025-05-25｜件数制御の主語責任整理：emolog / tukkomi の構造修正

---

## 🧭 背景と課題

各featureにおいて、GPTからの出力件数を制限するための定数（例：`MAX_HONEST_COUNT`, `MAX_TUKKOMI_COUNT`）が
**prompt生成とparser整形の両方で直接参照されていた**。

この構造には以下の問題があった：

- **「どこが主語か」が曖昧で、制御責任が分散していた**
- 定数を複数モジュールで読み込むことで、**設定変更時に構造整合性が壊れやすくなっていた**
- parserが定数を持つと、**「制御者」と「整形者」の役割が混在してしまう**

---

## 🧱 構造判断

### ✅ 結論

> 件数を制御する定数の責任は、**bot（制御の主語）に集約**し、
> parserには **整形ルールとして明示的に渡す構造**に変更した。

---

## 📐 修正後の責務分担

| モジュール     | 役割                   | 件数制御の扱い               |
|----------------|------------------------|------------------------------|
| `bot.py`       | 設定値の制御・決定      | ✅ 定数を読み、必要箇所に渡す |
| `prompt.py`    | GPT入力構造の生成       | ✅ botから渡された値を埋め込む |
| `parser.py`    | GPT出力の整形（受動）   | ✅ botから渡された引数で整形（定数は持たない） |

---

## 🔍 なぜこの構造にしたか（意図）

- **parserは“出力を整えるだけ”の責務に限定**すべき
- 定数はbotが持ち、**prompt・parserへ渡す主語の明確化**が必要
- 構造制御と整形処理が**混ざってはいけない**（柔軟性・保守性の低下を招く）

---

## 🔎 全モジュール監査結果

| モジュール機能           | 構造状態         | 修正要否 | 対応 |
|--------------------------|------------------|----------|------|
| `emolog`                 | ❌ 分散あり       | ✅ 修正済 |
| `tukkomi`                | ❌ 分散あり       | ✅ 修正済 |
| `message_from_the_moon` | ✅ prompt主語     | 不要     | 済   |
| `point_of_view`          | ✅ prompt主語     | 不要     | 済   |
| `quiet_cosmos`           | ✅ prompt主語     | 不要     | 済   |
| `turtle`                 | ✅ prompt主語     | 不要     | 済   |

---

## 🛡️ 今後の指針

- 件数・上限・温度など「出力構造に関わる定数」は**必ずbot側で一元制御する**
- parserやpromptには**引数として“制御された値”を渡すだけの構造**に統一する
- 機能が増える場合も、「主語の曖昧化」には最大の注意を払うこと

